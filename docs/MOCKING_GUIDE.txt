"""
====================================================================================================
MOCK EMAIL & GEOCODING - COMPLETE GUIDE FOR DUMMIES ğŸ¯
====================================================================================================

## THE SIMPLE ANSWER TO YOUR QUESTION

Question: "how do we mock email/geocoding like i dont understand what we have to do, 
           install some library or what?"

Answer:   NO NEW LIBRARIES! Just use the SAME factory pattern we used for database!


====================================================================================================
SIDE-BY-SIDE COMPARISON
====================================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DATABASE MOCKING            â”‚      EMAIL/GEOCODING MOCKING        â”‚
â”‚         (You already have!)         â”‚      (Just added this!)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚                                     â”‚
â”‚ # database.py                       â”‚ # email.py / geocoding.py           â”‚
â”‚                                     â”‚                                     â”‚
â”‚ class MockSupabaseClient:           â”‚ class MockEmailService:             â”‚
â”‚     def table(self):                â”‚     def send_email(self):           â”‚
â”‚         return FakeTable()          â”‚         self.sent_emails.append()   â”‚
â”‚         â†‘ Returns fake data         â”‚         â†‘ Stores, doesn't send      â”‚
â”‚                                     â”‚                                     â”‚
â”‚ def get_db():                       â”‚ def get_email_service():            â”‚
â”‚     if ENVIRONMENT == "test":       â”‚     if ENVIRONMENT == "test":       â”‚
â”‚         return MockSupabaseClient() â”‚         return MockEmailService()   â”‚
â”‚     return RealClient()             â”‚     return RealEmailService()       â”‚
â”‚     â†‘ Factory function              â”‚     â†‘ Same factory pattern!         â”‚
â”‚                                     â”‚                                     â”‚
â”‚ db = get_db()                       â”‚ email_service = get_email_service() â”‚
â”‚ â†‘ Global instance using factory     â”‚ â†‘ Same approach!                    â”‚
â”‚                                     â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


====================================================================================================
WHAT WE DID (Step-by-Step)
====================================================================================================

STEP 1: Created Mock Classes
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

email.py:
   class MockEmailService:
       def __init__(self):
           self.sent_emails = []  # â† Store emails here instead of sending
       
       def send_vendor_approval_email(...):
           # Don't send real email, just store it
           self.sent_emails.append({...})
           return True

geocoding.py:
   class MockGeocodingService:
       async def geocode_address(self, address):
           # Don't call API, just return fake coordinates
           return (19.0760, 72.8777)  # Fake Mumbai coords


STEP 2: Created Factory Functions
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

email.py:
   def get_email_service():
       if settings.ENVIRONMENT == "test":
           return MockEmailService()  # â† Fake
       return EmailService()          # â† Real

geocoding.py:
   def get_geocoding_service():
       if settings.ENVIRONMENT == "test":
           return MockGeocodingService()  # â† Fake
       return GeocodingService()          # â† Real


STEP 3: Changed Global Instances
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

email.py:
   # Before:
   email_service = EmailService()  # âŒ Always real
   
   # After:
   email_service = get_email_service()  # âœ… Mock in tests!

geocoding.py:
   # Before:
   geocoding_service = GeocodingService()  # âŒ Always real
   
   # After:
   geocoding_service = get_geocoding_service()  # âœ… Mock in tests!


====================================================================================================
HOW TO USE IN TESTS
====================================================================================================

# test_something.py

import os

# STEP 1: Set environment BEFORE importing anything!
os.environ["ENVIRONMENT"] = "test"

# STEP 2: Now import - these will be MOCK services!
from app.services.email import email_service
from app.services.geocoding import geocoding_service
from app.services.booking_service import BookingService

# STEP 3: Test your code
async def test_create_booking():
    # Clear previous test data
    email_service.sent_emails = []
    
    # Create booking (internally sends email)
    service = BookingService()
    booking = await service.create_booking(
        booking_data=...,
        user_id="test_user"
    )
    
    # âœ… Verify email was "sent" (actually just stored!)
    assert len(email_service.sent_emails) == 1
    assert email_service.sent_emails[0]["to_email"] == "customer@test.com"
    assert "confirmation" in email_service.sent_emails[0]["subject"].lower()
    
    # âœ… No real email was sent!
    # âœ… Test runs instantly!
    # âœ… No SMTP server needed!

async def test_vendor_approval():
    # Approve vendor (internally geocodes address)
    coords = await geocoding_service.geocode_address("123 Test St, Mumbai")
    
    # âœ… Returns fake coordinates!
    assert coords == (19.0760, 72.8777)
    
    # âœ… No API call was made!
    # âœ… No API key needed!
    # âœ… Test runs instantly!


====================================================================================================
WHAT YOU CAN CHECK IN TESTS
====================================================================================================

EMAIL MOCKING:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   email_service.sent_emails  # â† List of all "sent" emails
   
   Each email has:
   - to_email: "customer@example.com"
   - subject: "Booking Confirmed"
   - html_body: "<html>...</html>"
   - text_body: "..."
   
   Example test:
   assert len(email_service.sent_emails) == 1
   assert email_service.sent_emails[0]["to_email"] == "test@example.com"

GEOCODING MOCKING:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   coords = await geocoding_service.geocode_address("any address")
   # Always returns: (19.0760, 72.8777)
   
   address = await geocoding_service.reverse_geocode(19.0, 72.0)
   # Always returns: {"city": "Mumbai", "state": "Maharashtra", ...}


====================================================================================================
LIBRARIES INSTALLED: ZERO!
====================================================================================================

You DON'T need:
   âŒ pytest-mock
   âŒ unittest.mock
   âŒ responses (for HTTP mocking)
   âŒ faker (for fake data)
   âŒ factoryboy
   âŒ Any other mocking library!

You ONLY need:
   âœ… Factory pattern (same as database!)
   âœ… Environment variable (ENVIRONMENT=test)
   âœ… Mock classes (we just created them!)


====================================================================================================
COMPARISON: BEFORE vs AFTER
====================================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BEFORE (Can't Test)          â”‚ AFTER (Can Test!)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ email_service = EmailService()â”‚ email_service =             â”‚
â”‚ â†“                            â”‚   get_email_service()        â”‚
â”‚ ALWAYS sends real email      â”‚ â†“                            â”‚
â”‚ âŒ Need SMTP server          â”‚ In test: MockEmailService    â”‚
â”‚ âŒ Need credentials          â”‚ In prod: EmailService        â”‚
â”‚ âŒ Slow tests                â”‚ âœ… No SMTP needed            â”‚
â”‚                              â”‚ âœ… Instant tests             â”‚
â”‚                              â”‚                              â”‚
â”‚ geocoding_service =          â”‚ geocoding_service =          â”‚
â”‚   GeocodingService()         â”‚   get_geocoding_service()    â”‚
â”‚ â†“                            â”‚ â†“                            â”‚
â”‚ ALWAYS calls API             â”‚ In test: MockGeocodingServiceâ”‚
â”‚ âŒ Need API key              â”‚ In prod: GeocodingService    â”‚
â”‚ âŒ Rate limits               â”‚ âœ… No API key needed         â”‚
â”‚ âŒ Slow tests                â”‚ âœ… Instant tests             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


====================================================================================================
YOUR COMPLETE MOCKING STACK
====================================================================================================

1. DATABASE MOCKING âœ… (Already done)
   - MockSupabaseClient
   - get_db() factory
   - Works in test mode

2. EMAIL MOCKING âœ… (Just added!)
   - MockEmailService
   - get_email_service() factory
   - Works in test mode

3. GEOCODING MOCKING âœ… (Just added!)
   - MockGeocodingService
   - get_geocoding_service() factory
   - Works in test mode


YOU CAN NOW TEST EVERYTHING WITHOUT:
   âŒ Real database
   âŒ Real SMTP server
   âŒ Real geocoding API
   âŒ Any credentials
   âŒ Network connection


====================================================================================================
FINAL SUMMARY
====================================================================================================

Question: "how do we mock email/geocoding like i dont understand what we have to do, 
           install some library or what?"

Answer:   âœ… NO libraries to install!
          âœ… Just use factory pattern (same as database!)
          âœ… We created MockEmailService and MockGeocodingService
          âœ… We created get_email_service() and get_geocoding_service()
          âœ… Changed singletons to use factories
          âœ… In test mode (ENVIRONMENT=test), you get mocks automatically!

It's the EXACT SAME approach as database mocking!
You already understand this! ğŸ¯


====================================================================================================
"""

if __name__ == "__main__":
    print(__doc__)
