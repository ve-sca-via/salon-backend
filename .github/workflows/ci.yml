name: CI - Smoke Build Check

# Only run on pull requests to main (not on pushes)
on:
  pull_request:
    branches:
      - main

jobs:
  smoke-build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python 3.13.4 (matches Render's Python version exactly)
      - name: Set up Python 3.13.4
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.4'
          cache: 'pip'  # Cache pip dependencies for faster builds

      # 3. Install system dependencies (python-magic requires libmagic C library)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1

      # 4. Install Python dependencies from requirements.txt
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo " No requirements.txt found"
            exit 1
          fi

      # 5. Smoke test: Try importing the main application module
      #    This validates all dependencies install correctly and are compatible
      - name: Smoke build check
        run: |
          python -c "import main; print(' Application imports successfully')"
        env:
          # Required env vars (no defaults in config)
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          JWT_SECRET_KEY: "dummy-jwt-secret-key-for-ci-testing-at-least-32-characters-long"
          # Optional env vars with defaults (set to prevent any issues)
          SUPABASE_URL: "https://dummy.supabase.co"
          SUPABASE_ANON_KEY: "dummy-anon-key"
          SUPABASE_SERVICE_ROLE_KEY: "dummy-service-key"
          ENVIRONMENT: "ci"
